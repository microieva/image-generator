name: Deploy to DataCrunch

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
    - run: ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
    - name: Deploy to server
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
          set -e  # Exit on any error
          cd /root/image-generator
          
          echo "ðŸš€ Starting deployment process..."
          
          # Stop existing containers
          echo "ðŸ›‘ Stopping existing containers..."
          docker compose down || echo "âš ï¸  No containers to stop (first deployment?)"
          
          # Pull latest code
          echo "ðŸ“¥ Pulling latest code..."
          git pull origin main
          
          # Run setup script
          echo "ðŸ”§ Running setup script..."
          chmod +x setup.sh
          ./setup.sh
          
          # Verify deployment
          echo "ðŸ” Verifying deployment..."
          sleep 10  # Wait for containers to start
          docker compose ps
          
          echo "ðŸŽ‰ Deployment completed successfully!"
        EOF